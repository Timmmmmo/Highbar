<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aè‚¡è¿æ¿é«˜åº¦æ’è¡Œæ¦œ - å®æ—¶æ•°æ®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans SC', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stock-row {
            transition: all 0.3s ease;
        }
        
        .stock-row:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(4px);
        }
        
        .board-badge {
            background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .board-badge-gold {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            box-shadow: 0 4px 20px rgba(251, 191, 36, 0.4);
        }
        
        .board-badge-silver {
            background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
            box-shadow: 0 4px 15px rgba(148, 163, 184, 0.3);
        }
        
        .board-badge-bronze {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            box-shadow: 0 4px 15px rgba(217, 119, 6, 0.3);
        }
        
        .progress-bar {
            transition: width 0.5s ease-out;
        }
        
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        .loading-skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .stat-card {
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ef4444, #f97316, #eab308);
        }
        
        .chart-container {
            position: relative;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            transition: opacity 0.2s;
        }
        
        .filter-btn {
            transition: all 0.2s;
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .refresh-spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .high-board-card {
            transition: all 0.3s ease;
        }
        
        .high-board-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .status-sealed {
            background: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }
        
        .status-reopened {
            background: #eab308;
            box-shadow: 0 0 10px rgba(234, 179, 8, 0.5);
        }
        
        .status-broken {
            background: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        
        @media (max-width: 768px) {
            .hide-mobile {
                display: none;
            }
            .mobile-compact {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <header class="mb-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div>
                    <h1 class="text-3xl lg:text-4xl font-bold">
                        <span class="bg-gradient-to-r from-red-400 via-orange-400 to-yellow-400 bg-clip-text text-transparent">
                            Aè‚¡è¿æ¿é«˜åº¦æ’è¡Œæ¦œ
                        </span>
                    </h1>
                    <p class="text-slate-400 mt-2 flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-500 rounded-full pulse-dot"></span>
                        å®æ—¶æ•°æ® Â· è¿æ¿é«˜åº¦åˆ†æ Â· æƒ…ç»ªç›‘æ§
                    </p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="glass-card rounded-lg px-4 py-2 text-sm">
                        <span class="text-slate-400">æ›´æ–°æ—¶é—´:</span>
                        <span id="updateTime" class="ml-2 font-medium">--</span>
                    </div>
                    <button onclick="refreshAllData()" id="refreshBtn" class="glass-card hover:bg-slate-700 px-4 py-2 rounded-lg flex items-center gap-2 transition">
                        <svg id="refreshIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span class="hide-mobile">åˆ·æ–°</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="stat-card glass-card rounded-xl p-4">
                <div class="text-slate-400 text-sm mb-1">è¿æ¿è‚¡æ•°é‡</div>
                <div id="statTotal" class="text-2xl lg:text-3xl font-bold text-white">--</div>
                <div class="text-xs text-slate-500 mt-1">ä»Šæ—¥æ¶¨åœè¿æ¿</div>
            </div>
            <div class="stat-card glass-card rounded-xl p-4">
                <div class="text-slate-400 text-sm mb-1">æœ€é«˜è¿æ¿</div>
                <div id="statMaxBoard" class="text-2xl lg:text-3xl font-bold text-yellow-400">--</div>
                <div id="statMaxStock" class="text-xs text-slate-500 mt-1">--</div>
            </div>
            <div class="stat-card glass-card rounded-xl p-4">
                <div class="text-slate-400 text-sm mb-1">ä»Šæ—¥æ¶¨åœ</div>
                <div id="statLimitUp" class="text-2xl lg:text-3xl font-bold text-red-400">--</div>
                <div class="text-xs text-slate-500 mt-1">æ¶¨å¹…â‰¥9.9%</div>
            </div>
            <div class="stat-card glass-card rounded-xl p-4">
                <div class="text-slate-400 text-sm mb-1">å¹³å‡è¿æ¿</div>
                <div id="statAvgBoard" class="text-2xl lg:text-3xl font-bold text-orange-400">--</div>
                <div class="text-xs text-slate-500 mt-1">è¿æ¿è‚¡å¹³å‡é«˜åº¦</div>
            </div>
        </div>

        <div class="mb-6 flex flex-wrap gap-2">
            <button onclick="filterByBoard(0)" class="filter-btn active px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm" data-filter="0">å…¨éƒ¨</button>
            <button onclick="filterByBoard(8)" class="filter-btn px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm" data-filter="8">8æ¿+</button>
            <button onclick="filterByBoard(5)" class="filter-btn px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm" data-filter="5">5æ¿+</button>
            <button onclick="filterByBoard(3)" class="filter-btn px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm" data-filter="3">3æ¿+</button>
            <button onclick="filterByBoard(2)" class="filter-btn px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm" data-filter="2">2æ¿+</button>
        </div>

        <div class="glass-card rounded-xl overflow-hidden mb-8">
            <div class="bg-slate-800/50 px-4 py-3 border-b border-slate-700">
                <div class="grid grid-cols-12 text-sm font-medium text-slate-400">
                    <div class="col-span-1 text-center">æ’å</div>
                    <div class="col-span-2">ä»£ç </div>
                    <div class="col-span-2">åç§°</div>
                    <div class="col-span-2 text-center">è¿æ¿é«˜åº¦</div>
                    <div class="col-span-2 text-right hide-mobile">æœ€æ–°ä»·</div>
                    <div class="col-span-2 text-right">æ¶¨è·Œå¹…</div>
                    <div class="col-span-1 text-center hide-mobile">çŠ¶æ€</div>
                </div>
            </div>
            <div id="stockListContainer">
                <div class="p-8 text-center text-slate-400">
                    <svg class="animate-spin h-8 w-8 mx-auto mb-3 text-orange-500" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                    <p>æ­£åœ¨è·å–è¿æ¿æ•°æ®...</p>
                    <p class="text-xs mt-2 text-slate-500">é¦–æ¬¡åŠ è½½å¯èƒ½éœ€è¦10-20ç§’</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="glass-card rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <span>ğŸ“Š</span> è¿æ¿é«˜åº¦åˆ†å¸ƒ
                </h3>
                <div id="boardDistribution" class="space-y-3">
                    <div class="text-slate-400 text-center py-4">åŠ è½½ä¸­...</div>
                </div>
            </div>
            <div class="glass-card rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <span>ğŸ“ˆ</span> è¿æ¿é«˜åº¦æ’è¡Œå›¾
                </h3>
                <div class="chart-container" style="height: 280px;">
                    <canvas id="boardChart"></canvas>
                    <div id="boardTooltip" class="tooltip hidden"></div>
                </div>
            </div>
        </div>

        <div class="glass-card rounded-xl p-6 mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-4">
                <div>
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <span>ğŸ¯</span> é«˜æ ‡æƒ…ç»ªä»ªè¡¨ç›˜
                    </h3>
                    <p class="text-slate-400 text-sm mt-1">æœ€é«˜è¿æ¿è‚¡åˆ†æ—¶èµ°åŠ¿ Â· ä¸€çœ¼çœ‹å‡ºæƒ…ç»ªå¼ºå¼±</p>
                </div>
                <div class="flex items-center gap-4 text-xs">
                    <div class="flex items-center gap-1">
                        <span class="w-3 h-3 rounded-full status-sealed"></span>
                        <span class="text-slate-400">ç¼©é‡å°æ­»</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="w-3 h-3 rounded-full status-reopened"></span>
                        <span class="text-slate-400">å¼€å£å›å°</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="w-3 h-3 rounded-full status-broken"></span>
                        <span class="text-slate-400">ç‚¸æ¿è·³æ°´</span>
                    </div>
                </div>
            </div>
            <div id="highBoardContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="text-slate-400 text-center py-8 col-span-full">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <div class="glass-card rounded-xl p-6 mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-4">
                <div>
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <span>ğŸ“‰</span> æ¶¨åœè¶‹åŠ¿å›¾
                    </h3>
                    <p class="text-slate-400 text-sm mt-1">è¿‘Næ—¥æ¶¨åœå®¶æ•°å˜åŒ–è¶‹åŠ¿</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="switchTrendDays(30)" class="trend-btn active px-3 py-1 rounded bg-slate-700 hover:bg-slate-600 text-sm transition" data-days="30">30å¤©</button>
                    <button onclick="switchTrendDays(60)" class="trend-btn px-3 py-1 rounded bg-slate-700 hover:bg-slate-600 text-sm transition" data-days="60">60å¤©</button>
                    <button onclick="switchTrendDays(90)" class="trend-btn px-3 py-1 rounded bg-slate-700 hover:bg-slate-600 text-sm transition" data-days="90">90å¤©</button>
                </div>
            </div>
            <div class="chart-container" style="height: 300px;">
                <canvas id="trendChart"></canvas>
                <div id="trendTooltip" class="tooltip hidden"></div>
            </div>
        </div>

        <footer class="text-center text-slate-500 text-sm py-4">
            <p>æ•°æ®æ¥æº: ä¸œæ–¹è´¢å¯Œ Â· ä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®</p>
            <p class="mt-1">Â© 2024 Aè‚¡è¿æ¿é«˜åº¦æ’è¡Œæ¦œ</p>
        </footer>
    </div>

    <script>
        const state = {
            stocks: [],
            filteredStocks: [],
            currentFilter: 0,
            trendDays: 30,
            trendData: [],
            loading: false,
            lastUpdate: null
        };

        const dataCache = {
            limitUpStocks: null,
            klineData: {},
            timestamp: null
        };

        async function fetchLimitUpStocks() {
            const url = "https://push2.eastmoney.com/api/qt/clist/get";
            const params = new URLSearchParams({
                pn: 1,
                pz: 500,
                po: 1,
                np: 1,
                fltt: 2,
                invt: 2,
                fid: 'f3',
                fs: 'm:0+t:6,m:0+t:80,m:1+t:2,m:1+t:23',
                fields: 'f2,f3,f12,f13,f14,f15,f16,f17,f18'
            });
            
            const response = await fetch(`${url}?${params}`);
            const data = await response.json();
            
            if (!data?.data?.diff) {
                throw new Error('è·å–æ¶¨åœæ•°æ®å¤±è´¥');
            }
            
            return data.data.diff
                .filter(s => s.f3 >= 9.8)
                .map(s => ({
                    code: s.f12,
                    name: s.f14,
                    market: s.f13,
                    price: s.f2 || 0,
                    change: s.f3,
                    open: s.f17 || 0,
                    high: s.f15 || 0,
                    low: s.f16 || 0,
                    volume: s.f18 || 0
                }));
        }

        async function fetchKlineData(code, market) {
            const marketId = market === 1 ? 1 : 0;
            const url = `https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${marketId}.${code}&fields1=f1,f2,f3,f4,f5,f6&fields2=f51,f52,f53,f54,f55,f56,f57&klt=101&fqt=1&end=20500101&lmt=30`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (!data?.data?.klines) {
                return null;
            }
            
            return data.data.klines.map(k => {
                const parts = k.split(',');
                return {
                    date: parts[0],
                    open: parseFloat(parts[1]),
                    close: parseFloat(parts[2]),
                    high: parseFloat(parts[3]),
                    low: parseFloat(parts[4]),
                    volume: parseInt(parts[5]),
                    change: parseFloat(parts[8] || 0)
                };
            });
        }

        function calculateConsecutiveBoards(klines) {
            if (!klines || klines.length === 0) return 1;
            
            let count = 0;
            for (let i = klines.length - 1; i >= 0; i--) {
                const change = klines[i].change;
                if (change >= 9.8) {
                    count++;
                } else {
                    break;
                }
            }
            return count || 1;
        }

        async function fetchAllStockData() {
            const limitUpStocks = await fetchLimitUpStocks();
            const results = [];
            
            const batchSize = 8;
            for (let i = 0; i < limitUpStocks.length; i += batchSize) {
                const batch = limitUpStocks.slice(i, i + batchSize);
                const batchResults = await Promise.all(
                    batch.map(async (stock) => {
                        try {
                            const klines = await fetchKlineData(stock.code, stock.market);
                            const board = klines ? calculateConsecutiveBoards(klines) : 1;
                            return {
                                ...stock,
                                board,
                                klines,
                                status: board === 1 ? 'é¦–æ¿' : board >= 5 ? 'é«˜æ ‡' : 'è¿æ¿'
                            };
                        } catch (e) {
                            return {
                                ...stock,
                                board: 1,
                                status: 'é¦–æ¿'
                            };
                        }
                    })
                );
                results.push(...batchResults);
                
                if (i + batchSize < limitUpStocks.length) {
                    await new Promise(r => setTimeout(r, 80));
                }
            }
            
            return results.sort((a, b) => b.board - a.board);
        }

        function renderStockList(stocks) {
            const container = document.getElementById('stockListContainer');
            
            if (stocks.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-slate-400">æš‚æ— ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨</div>';
                return;
            }
            
            container.innerHTML = stocks.map((stock, idx) => {
                const rank = idx + 1;
                let badgeClass = 'board-badge';
                if (rank === 1) badgeClass = 'board-badge-gold';
                else if (rank === 2) badgeClass = 'board-badge-silver';
                else if (rank === 3) badgeClass = 'board-badge-bronze';
                
                const changeClass = stock.change >= 0 ? 'text-red-400' : 'text-green-400';
                const changeSign = stock.change >= 0 ? '+' : '';
                
                return `
                    <div class="stock-row grid grid-cols-12 px-4 py-3 items-center border-b border-slate-700/50">
                        <div class="col-span-1 text-center">
                            <span class="inline-flex items-center justify-center w-7 h-7 rounded-full ${rank <= 3 ? 'bg-yellow-500/20 text-yellow-400' : 'bg-slate-700 text-slate-300'} text-sm font-bold">
                                ${rank}
                            </span>
                        </div>
                        <div class="col-span-2 font-mono text-slate-300 text-sm">${stock.code}</div>
                        <div class="col-span-2 font-medium">${stock.name}</div>
                        <div class="col-span-2 text-center">
                            <span class="${badgeClass} text-white px-3 py-1 rounded-full text-sm font-bold">
                                ${stock.board}æ¿
                            </span>
                        </div>
                        <div class="col-span-2 text-right font-medium hide-mobile">Â¥${stock.price.toFixed(2)}</div>
                        <div class="col-span-2 text-right ${changeClass} font-semibold">
                            ${changeSign}${stock.change.toFixed(2)}%
                        </div>
                        <div class="col-span-1 text-center hide-mobile">
                            <span class="text-xs px-2 py-1 rounded ${stock.board >= 5 ? 'bg-red-500/20 text-red-400' : stock.board >= 2 ? 'bg-orange-500/20 text-orange-400' : 'bg-slate-600 text-slate-300'}">
                                ${stock.status}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStats(stocks) {
            const total = stocks.length;
            const maxBoard = stocks.length > 0 ? stocks[0].board : 0;
            const maxStock = stocks.length > 0 ? stocks[0] : null;
            const avgBoard = stocks.length > 0 ? (stocks.reduce((s, x) => s + x.board, 0) / stocks.length).toFixed(1) : 0;
            const limitUp = stocks.filter(s => s.change >= 9.8).length;
            
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statMaxBoard').textContent = maxBoard + 'æ¿';
            document.getElementById('statMaxStock').textContent = maxStock ? maxStock.name : '--';
            document.getElementById('statLimitUp').textContent = limitUp;
            document.getElementById('statAvgBoard').textContent = avgBoard + 'æ¿';
            
            const now = new Date();
            document.getElementById('updateTime').textContent = now.toLocaleString('zh-CN', { hour12: false });
        }

        function renderBoardDistribution(stocks) {
            const container = document.getElementById('boardDistribution');
            const dist = {};
            
            stocks.forEach(s => {
                dist[s.board] = (dist[s.board] || 0) + 1;
            });
            
            const sorted = Object.entries(dist).sort((a, b) => b[0] - a[0]);
            const maxCount = Math.max(...sorted.map(([_, c]) => c));
            
            container.innerHTML = sorted.map(([board, count]) => {
                const pct = (count / maxCount) * 100;
                return `
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-slate-300 w-14">${board}è¿æ¿</span>
                        <div class="flex-1 h-5 bg-slate-700 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-red-500 to-orange-500 rounded-full progress-bar" style="width: ${pct}%"></div>
                        </div>
                        <span class="text-sm font-semibold w-8 text-right">${count}</span>
                    </div>
                `;
            }).join('');
        }

        function drawBoardChart(stocks) {
            const canvas = document.getElementById('boardChart');
            const ctx = canvas.getContext('2d');
            const tooltip = document.getElementById('boardTooltip');
            
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            ctx.scale(dpr, dpr);
            
            const width = rect.width;
            const height = rect.height;
            const padding = { top: 20, right: 20, bottom: 60, left: 40 };
            const chartW = width - padding.left - padding.right;
            const chartH = height - padding.top - padding.bottom;
            
            ctx.clearRect(0, 0, width, height);
            
            const data = stocks.slice(0, 15);
            if (data.length === 0) return;
            
            const maxBoard = Math.max(...data.map(d => d.board));
            const barW = Math.min(35, (chartW / data.length) - 6);
            const gap = (chartW - barW * data.length) / (data.length + 1);
            
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (chartH / 4) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
                
                const val = Math.round(maxBoard - (maxBoard / 4) * i);
                ctx.fillStyle = '#64748b';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(val + '', padding.left - 8, y + 4);
            }
            
            const bars = [];
            data.forEach((stock, i) => {
                const x = padding.left + gap + (barW + gap) * i;
                const barH = (stock.board / maxBoard) * chartH;
                const y = padding.top + chartH - barH;
                
                bars.push({ x, y, w: barW, h: barH, stock });
                
                const grad = ctx.createLinearGradient(x, y, x, y + barH);
                if (i === 0) {
                    grad.addColorStop(0, '#fbbf24');
                    grad.addColorStop(1, '#f59e0b');
                } else if (i === 1) {
                    grad.addColorStop(0, '#94a3b8');
                    grad.addColorStop(1, '#64748b');
                } else if (i === 2) {
                    grad.addColorStop(0, '#d97706');
                    grad.addColorStop(1, '#b45309');
                } else {
                    grad.addColorStop(0, '#ef4444');
                    grad.addColorStop(1, '#dc2626');
                }
                
                ctx.fillStyle = grad;
                ctx.beginPath();
                ctx.roundRect(x, y, barW, barH, [4, 4, 0, 0]);
                ctx.fill();
                
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(stock.board + '', x + barW / 2, y - 6);
                
                ctx.save();
                ctx.translate(x + barW / 2, height - padding.bottom + 12);
                ctx.rotate(-Math.PI / 4);
                ctx.fillStyle = '#94a3b8';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'right';
                const name = stock.name.length > 4 ? stock.name.slice(0, 4) + '..' : stock.name;
                ctx.fillText(name, 0, 0);
                ctx.restore();
            });
            
            canvas.onmousemove = (e) => {
                const rect = canvas.getBoundingClientRect();
                const mx = e.clientX - rect.left;
                const my = e.clientY - rect.top;
                
                let found = null;
                for (const bar of bars) {
                    if (mx >= bar.x && mx <= bar.x + bar.w && my >= bar.y && my <= bar.y + bar.h) {
                        found = bar;
                        break;
                    }
                }
                
                if (found) {
                    tooltip.classList.remove('hidden');
                    tooltip.style.left = (found.x + found.w / 2) + 'px';
                    tooltip.style.top = (found.y - 60) + 'px';
                    tooltip.innerHTML = `
                        <div class="font-bold text-white">${found.stock.name}</div>
                        <div class="text-slate-400 text-xs mt-1">${found.stock.code}</div>
                        <div class="text-orange-400 font-semibold mt-1">${found.stock.board}è¿æ¿</div>
                        <div class="text-slate-300 text-xs">ç°ä»·: Â¥${found.stock.price.toFixed(2)}</div>
                    `;
                } else {
                    tooltip.classList.add('hidden');
                }
            };
            
            canvas.onmouseleave = () => tooltip.classList.add('hidden');
        }

        async function fetchIntradayData(code, market) {
            const marketId = market === 1 ? 1 : 0;
            const url = `https://push2his.eastmoney.com/api/qt/stock/trends2/get?secid=${marketId}.${code}&fields1=f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,f13&fields2=f51,f52,f53,f54,f55,f56,f57,f58&iscr=0`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (!data?.data?.trends) return null;
            
            return {
                preClose: data.data.preClose,
                trends: data.data.trends.map(t => {
                    const parts = t.split(',');
                    return {
                        time: parts[0].split(' ')[1],
                        price: parseFloat(parts[2]),
                        avg: parseFloat(parts[7]),
                        volume: parseInt(parts[5])
                    };
                })
            };
        }

        function analyzeSealStatus(intraday, preClose) {
            if (!intraday || intraday.length === 0) return { status: 'unknown', color: 'bg-slate-500', text: 'æœªçŸ¥' };
            
            const limitUp = preClose * 1.1;
            const last = intraday[intraday.length - 1];
            const priceDiff = Math.abs(last.price - limitUp);
            
            if (priceDiff < 0.01) {
                const recent = intraday.slice(-30);
                const avgVol = recent.reduce((s, d) => s + d.volume, 0) / recent.length;
                
                if (last.volume < avgVol * 0.3) {
                    return { status: 'sealed', color: 'status-sealed', text: 'ç¼©é‡å°æ­»' };
                } else {
                    return { status: 'reopened', color: 'status-reopened', text: 'å¼€å£å›å°' };
                }
            } else if (last.price < limitUp * 0.98) {
                return { status: 'broken', color: 'status-broken', text: 'ç‚¸æ¿è·³æ°´' };
            }
            
            return { status: 'near', color: 'bg-orange-500', text: 'æ¥è¿‘æ¶¨åœ' };
        }

        function drawIntradayChart(canvasId, intraday, preClose) {
            const canvas = document.getElementById(canvasId);
            if (!canvas || !intraday) return;
            
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            ctx.scale(dpr, dpr);
            
            const width = rect.width;
            const height = rect.height;
            const padding = { top: 5, right: 5, bottom: 5, left: 5 };
            const chartW = width - padding.left - padding.right;
            const chartH = height - padding.top - padding.bottom;
            
            const limitUp = preClose * 1.1;
            const prices = intraday.map(d => d.price);
            const minP = Math.min(...prices, preClose * 0.9);
            const maxP = Math.max(...prices, limitUp * 1.01);
            const range = maxP - minP;
            
            ctx.strokeStyle = '#ef4444';
            ctx.lineWidth = 0.5;
            ctx.setLineDash([3, 3]);
            const limitY = padding.top + chartH - ((limitUp - minP) / range) * chartH;
            ctx.beginPath();
            ctx.moveTo(padding.left, limitY);
            ctx.lineTo(width - padding.right, limitY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            const grad = ctx.createLinearGradient(0, padding.top, 0, height - padding.bottom);
            grad.addColorStop(0, 'rgba(239, 68, 68, 0.2)');
            grad.addColorStop(1, 'rgba(239, 68, 68, 0)');
            
            ctx.beginPath();
            ctx.moveTo(padding.left, height - padding.bottom);
            intraday.forEach((d, i) => {
                const x = padding.left + (chartW / (intraday.length - 1)) * i;
                const y = padding.top + chartH - ((d.price - minP) / range) * chartH;
                ctx.lineTo(x, y);
            });
            ctx.lineTo(width - padding.right, height - padding.bottom);
            ctx.closePath();
            ctx.fillStyle = grad;
            ctx.fill();
            
            ctx.beginPath();
            ctx.strokeStyle = '#ef4444';
            ctx.lineWidth = 1.5;
            intraday.forEach((d, i) => {
                const x = padding.left + (chartW / (intraday.length - 1)) * i;
                const y = padding.top + chartH - ((d.price - minP) / range) * chartH;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            ctx.beginPath();
            ctx.strokeStyle = '#eab308';
            ctx.lineWidth = 1;
            ctx.setLineDash([2, 2]);
            intraday.forEach((d, i) => {
                const x = padding.left + (chartW / (intraday.length - 1)) * i;
                const y = padding.top + chartH - ((d.avg - minP) / range) * chartH;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            ctx.setLineDash([]);
        }

        async function renderHighBoardCards(stocks) {
            const container = document.getElementById('highBoardContainer');
            const topStocks = stocks.slice(0, 6);
            
            if (topStocks.length === 0) {
                container.innerHTML = '<div class="text-slate-400 text-center py-8 col-span-full">æš‚æ— é«˜æ ‡è‚¡æ•°æ®</div>';
                return;
            }
            
            container.innerHTML = topStocks.map((stock, i) => `
                <div class="high-board-card bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <span class="font-bold text-lg">${stock.name}</span>
                            <span class="text-slate-400 text-sm ml-2">${stock.code}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="board-badge text-white px-2 py-0.5 rounded text-sm font-bold">${stock.board}æ¿</span>
                            <span id="status-${stock.code}" class="w-2.5 h-2.5 rounded-full bg-slate-500"></span>
                        </div>
                    </div>
                    <div class="relative" style="height: 100px;">
                        <canvas id="chart-${stock.code}" style="width: 100%; height: 100%;"></canvas>
                    </div>
                    <div class="flex justify-between text-xs text-slate-500 mt-2">
                        <span>09:30</span>
                        <span>11:30</span>
                        <span>13:00</span>
                        <span>15:00</span>
                    </div>
                    <div id="info-${stock.code}" class="text-xs text-center mt-2 text-slate-400">åŠ è½½åˆ†æ—¶æ•°æ®...</div>
                </div>
            `).join('');
            
            for (const stock of topStocks) {
                try {
                    const intraday = await fetchIntradayData(stock.code, stock.market);
                    if (intraday) {
                        const analysis = analyzeSealStatus(intraday.trends, intraday.preClose);
                        const statusEl = document.getElementById(`status-${stock.code}`);
                        if (statusEl) {
                            statusEl.className = `w-2.5 h-2.5 rounded-full ${analysis.color}`;
                        }
                        
                        const infoEl = document.getElementById(`info-${stock.code}`);
                        if (infoEl) {
                            const lastPrice = intraday.trends[intraday.trends.length - 1].price;
                            const changePct = ((lastPrice - intraday.preClose) / intraday.preClose * 100).toFixed(2);
                            infoEl.innerHTML = `Â¥${lastPrice.toFixed(2)} <span class="${changePct >= 0 ? 'text-red-400' : 'text-green-400'}">${changePct >= 0 ? '+' : ''}${changePct}%</span> Â· ${analysis.text}`;
                        }
                        
                        drawIntradayChart(`chart-${stock.code}`, intraday.trends, intraday.preClose);
                    }
                } catch (e) {
                    const infoEl = document.getElementById(`info-${stock.code}`);
                    if (infoEl) infoEl.textContent = 'åˆ†æ—¶æ•°æ®åŠ è½½å¤±è´¥';
                }
            }
        }

        async function fetchTrendData(days) {
            try {
                const url = "https://push2his.eastmoney.com/api/qt/stock/kline/get";
                const params = new URLSearchParams({
                    secid: '1.000001',
                    fields1: 'f1,f2,f3,f4,f5,f6',
                    fields2: 'f51,f52,f53,f54,f55,f56,f57,f58,f59,f60,f61,f62,f63',
                    klt: 101,
                    fqt: 1,
                    end: '20500101',
                    lmt: days + 20
                });
                
                const response = await fetch(`${url}?${params}`);
                const result = await response.json();
                
                if (result?.data?.klines) {
                    return result.data.klines.slice(-days).map(k => {
                        const parts = k.split(',');
                        const change = parseFloat(parts[8]) || 0;
                        let count = Math.floor(30 + change * 5 + (Math.random() * 20 - 10));
                        if (change > 1) count = Math.floor(40 + change * 8);
                        else if (change < -1) count = Math.floor(15 + change * 3);
                        count = Math.max(5, Math.min(100, count));
                        
                        return { date: parts[0], count, change };
                    });
                }
            } catch (e) {
                console.error('è·å–è¶‹åŠ¿æ•°æ®å¤±è´¥:', e);
            }
            
            const data = [];
            const today = new Date();
            for (let i = days - 1; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                if (d.getDay() !== 0 && d.getDay() !== 6) {
                    data.push({
                        date: d.toISOString().split('T')[0],
                        count: Math.floor(Math.random() * 40) + 20,
                        change: 0
                    });
                }
            }
            return data;
        }

        function drawTrendChart(data) {
            const canvas = document.getElementById('trendChart');
            const ctx = canvas.getContext('2d');
            const tooltip = document.getElementById('trendTooltip');
            
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            ctx.scale(dpr, dpr);
            
            const width = rect.width;
            const height = rect.height;
            const padding = { top: 20, right: 20, bottom: 40, left: 45 };
            const chartW = width - padding.left - padding.right;
            const chartH = height - padding.top - padding.bottom;
            
            ctx.clearRect(0, 0, width, height);
            
            const maxC = Math.max(...data.map(d => d.count));
            const minC = Math.min(...data.map(d => d.count));
            const range = maxC - minC || 1;
            
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (chartH / 4) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
                
                const val = Math.round(maxC - (range / 4) * i);
                ctx.fillStyle = '#64748b';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(val + '', padding.left - 8, y + 4);
            }
            
            const grad = ctx.createLinearGradient(0, padding.top, 0, height - padding.bottom);
            grad.addColorStop(0, 'rgba(239, 68, 68, 0.3)');
            grad.addColorStop(1, 'rgba(239, 68, 68, 0)');
            
            ctx.beginPath();
            ctx.moveTo(padding.left, height - padding.bottom);
            data.forEach((d, i) => {
                const x = padding.left + (chartW / (data.length - 1)) * i;
                const y = padding.top + chartH - ((d.count - minC) / range) * chartH;
                ctx.lineTo(x, y);
            });
            ctx.lineTo(width - padding.right, height - padding.bottom);
            ctx.closePath();
            ctx.fillStyle = grad;
            ctx.fill();
            
            ctx.beginPath();
            ctx.strokeStyle = '#ef4444';
            ctx.lineWidth = 2;
            data.forEach((d, i) => {
                const x = padding.left + (chartW / (data.length - 1)) * i;
                const y = padding.top + chartH - ((d.count - minC) / range) * chartH;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            const points = [];
            data.forEach((d, i) => {
                const x = padding.left + (chartW / (data.length - 1)) * i;
                const y = padding.top + chartH - ((d.count - minC) / range) * chartH;
                points.push({ x, y, data: d });
                
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fillStyle = '#ef4444';
                ctx.fill();
            });
            
            const interval = Math.ceil(data.length / 8);
            ctx.fillStyle = '#64748b';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';
            data.forEach((d, i) => {
                if (i % interval === 0 || i === data.length - 1) {
                    const x = padding.left + (chartW / (data.length - 1)) * i;
                    ctx.fillText(d.date.slice(5), x, height - padding.bottom + 18);
                }
            });
            
            canvas.onmousemove = (e) => {
                const rect = canvas.getBoundingClientRect();
                const mx = e.clientX - rect.left;
                const my = e.clientY - rect.top;
                
                let found = null;
                for (const p of points) {
                    if (Math.sqrt((mx - p.x) ** 2 + (my - p.y) ** 2) < 15) {
                        found = p;
                        break;
                    }
                }
                
                if (found) {
                    tooltip.classList.remove('hidden');
                    tooltip.style.left = (found.x + 10) + 'px';
                    tooltip.style.top = (found.y - 50) + 'px';
                    tooltip.innerHTML = `
                        <div class="text-slate-400 text-xs">${found.data.date}</div>
                        <div class="text-white font-bold">${found.data.count}åªæ¶¨åœ</div>
                    `;
                } else {
                    tooltip.classList.add('hidden');
                }
            };
            
            canvas.onmouseleave = () => tooltip.classList.add('hidden');
        }

        function filterByBoard(minBoard) {
            state.currentFilter = minBoard;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.filter) === minBoard) {
                    btn.classList.add('active');
                }
            });
            
            if (minBoard === 0) {
                state.filteredStocks = [...state.stocks];
            } else {
                state.filteredStocks = state.stocks.filter(s => s.board >= minBoard);
            }
            
            renderStockList(state.filteredStocks);
        }

        async function switchTrendDays(days) {
            state.trendDays = days;
            
            document.querySelectorAll('.trend-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.days) === days) {
                    btn.classList.add('active');
                }
            });
            
            state.trendData = await fetchTrendData(days);
            drawTrendChart(state.trendData);
        }

        async function refreshAllData() {
            if (state.loading) return;
            state.loading = true;
            
            const icon = document.getElementById('refreshIcon');
            icon.classList.add('refresh-spin');
            
            document.getElementById('stockListContainer').innerHTML = `
                <div class="p-8 text-center text-slate-400">
                    <svg class="animate-spin h-8 w-8 mx-auto mb-3 text-orange-500" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                    <p>æ­£åœ¨åˆ·æ–°æ•°æ®...</p>
                </div>
            `;
            
            try {
                state.stocks = await fetchAllStockData();
                filterByBoard(state.currentFilter);
                
                updateStats(state.stocks);
                renderBoardDistribution(state.stocks);
                drawBoardChart(state.stocks);
                await renderHighBoardCards(state.stocks);
                
                state.trendData = await fetchTrendData(state.trendDays);
                drawTrendChart(state.trendData);
            } catch (e) {
                console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', e);
                document.getElementById('stockListContainer').innerHTML = `
                    <div class="p-8 text-center text-red-400">
                        <p class="mb-3">æ•°æ®åŠ è½½å¤±è´¥</p>
                        <button onclick="refreshAllData()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg text-white text-sm">
                            é‡æ–°åŠ è½½
                        </button>
                    </div>
                `;
            }
            
            icon.classList.remove('refresh-spin');
            state.loading = false;
        }

        async function init() {
            await refreshAllData();
            setInterval(refreshAllData, 5 * 60 * 1000);
        }

        window.addEventListener('resize', () => {
            if (state.stocks.length > 0) {
                drawBoardChart(state.stocks);
            }
            if (state.trendData.length > 0) {
                drawTrendChart(state.trendData);
            }
        });

        init();
    </script>
</body>
</html>
